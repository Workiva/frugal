run:
  when-branch-name-is:
    - .+

also-run:
  Workiva/messaging-sdk:
    on-pull-request: true

image: "docker.webfilings.org/wlayout/smithy-runner-thrift:1.5"

env:
  - GORACE="halt_on_errors=1"

scripts:
  - testing=$PWD
  - cd ..
  - mkdir go
  - cd go
  - export GOPATH=$PWD
  - export PATH=$PATH:$GOPATH/bin
  - mkdir -p $GOPATH/src/github.com/Workiva
  - cp -r $testing $GOPATH/src/github.com/Workiva/frugal

  - cd $GOPATH/src/github.com/Workiva/frugal
  - export GOPATH=$GOPATH:$PWD
  - go get -d ./compiler .
  - go install

  - frugal=$PWD
  - go get -d -t ./lib/go .
  - go build ./lib/go
  - rm -rf $frugal/example/go/gen-go
  - cd $frugal/example
  - frugal --gen go:package_prefix=github.com/Workiva/frugal/example/go/gen-go/ -r --out='go/gen-go' event.frugal

  # Start nats server
  - cd $testing
  - go get github.com/nats-io/gnatsd
  - gnatsd &

  # recycle the Godeps (frugal-go) from lib/go
  - cd $frugal
  - ./scripts/run_tests_skynet.sh

timeout: long

test-reports:
  - /testing/reports
