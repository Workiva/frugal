run:
  when-branch-name-is:
    - .+

image: "drydock.workiva.org/workiva/skynet-images:33350"

also-run:
  Workiva/messaging-sdk:frugal-go-tests:
    on-pull-request: true
  Workiva/messaging-sdk:java-tests:
    on-pull-request: true

env:
  - GORACE="halt_on_errors=1"

scripts:
  # Grab thrift binary
  - mkdir -p $PWD/bin
  - wget -O $PWD/bin/thrift https://github.com/stevenosborne-wf/thrift/releases/download/0.9.3-wk-2/thrift-0.9.3-wk-2-linux-amd64 
  - chmod 0755 $PWD/bin/thrift
  - export PATH=$PATH:$PWD/bin

  - testing=$PWD
  - mkdir -p $GOPATH/src/github.com/Workiva
  - cp -r $testing $GOPATH/src/github.com/Workiva/frugal

  - cd $GOPATH/src/github.com/Workiva/frugal
  - export GOPATH=$GOPATH:$PWD
  - go get -d ./compiler .
  - go install

  - frugal=$PWD
  - go get -d -t ./lib/go .
  - go build ./lib/go
  - rm -rf $frugal/example/go/gen-go
  - cd $frugal/example
  - frugal --gen go:package_prefix=github.com/Workiva/frugal/example/go/gen-go/ -r --out='go/gen-go' event.frugal

  # Start nats server
  - cd $testing
  - go get github.com/nats-io/gnatsd
  - gnatsd &

  # recycle the Godeps (frugal-go) from lib/go
  - cd $frugal
  - ./scripts/run_tests_skynet.sh

timeout: long

test-reports:
  - /testing/reports
