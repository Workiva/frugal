name: standard

run:
  when-branch-name-is:
    - .+

contact: Jacob Moss

image: "drydock.workiva.org/workiva/skynet-images:48052"

also-run:
  Workiva/messaging-sdk:go-tests:
    on-pull-request: true
  Workiva/messaging-sdk:java-tests:
    on-pull-request: true

env:
  - GORACE="halt_on_errors=1"

scripts:
  - testing=$PWD
  - ./scripts/skynet_setup.sh

  - export PATH=$PATH:$PWD/bin
  - frugal=$GOPATH/src/github.com/Workiva/frugal
  - rm -rf $frugal/example/go/gen-go
  - cd $frugal/example
  - frugal --gen go:package_prefix=github.com/Workiva/frugal/example/go/gen-go/ -r --out='go/gen-go' event.frugal

  # Start nats server
  - cd $testing
  - wget -O gnatsd.tar.gz https://github.com/nats-io/gnatsd/releases/download/v0.7.2/gnatsd-v0.7.2-linux-amd64.tar.gz
  - tar xzf gnatsd.tar.gz
  - chmod 0755 gnatsd
  - ./gnatsd &

  # recycle the Godeps (frugal-go) from lib/go
  - cd $frugal
  - ./scripts/run_tests_skynet.sh

timeout: moderate

test-reports:
  - /testing/reports


---

name: cross

contact: Jacob Moss

description: Run cross language tests

requires:
  Workiva/frugal:
    - local_cache
    - artifactory
run:
  when-branch-name-is:
    - .+

image: "drydock.workiva.org/workiva/skynet-images:48052"

scripts:
  - testing=$PWD
  - ./scripts/skynet_setup.sh

  - export PATH=$PATH:$testing/bin

  # Catch non-zero exit code and fail after results are uploaded
  - ./scripts/run_cross.sh || code=$?

  # If applicable, fail here
  - if [ $code > 0 ]; then exit $code; fi

timeout: long

artifacts:
  - /testing/artifacts

---

name: cross-gen_with_frugal

contact: Jacob Moss

description: Run cross language tests with go and dart code generated entirely by frugal

requires:
  Workiva/frugal:
    - local_cache
    - artifactory
run:
  when-branch-name-is:
    - .+

image: "drydock.workiva.org/workiva/skynet-images:48052"

scripts:
  - testing=$PWD
  - ./scripts/skynet_setup.sh

  - export PATH=$PATH:$testing/bin

  # Catch non-zero exit code and fail after results are uploaded
  - ./scripts/run_cross.sh -gen_with_frugal || code=$?

  # If applicable, fail here
  - if [ $code > 0 ]; then exit $code; fi

timeout: long

artifacts:
  - /testing/artifacts
